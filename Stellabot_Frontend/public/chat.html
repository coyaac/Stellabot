<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stellabot Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
    <style>
      :root {
        --brand: #ca2ca3;
        --muted: #bbd1d9;
        --accent: #6a7445;
        --bg: #f6f7fb;
        --text: #151A22;
      }
      html, body { height: 100%; margin: 0; }
      body { background: var(--bg); font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, "Noto Sans"; color: var(--text); }
      .surface { height: 100%; display: grid; place-items: center; padding: 16px; }
      .panel {
        width: 420px; max-width: 100%; height: 640px; max-height: 100%;
        background: #fff; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,.18);
        display: grid; grid-template-rows: auto 1fr auto;
        overflow: hidden;
        animation: pop-in .28s ease-out both;
      }
      .header { background: var(--brand); color: #fff; padding: 12px 14px; display: grid; grid-template-columns: 1fr auto; align-items: center; }
      .title { font-weight: 700; letter-spacing: .2px; display: grid; grid-auto-flow: column; align-items: center; gap: 8px; }
      .ready { font-size: 12px; background: rgba(255,255,255,.22); padding: 2px 8px; border-radius: 999px; font-weight: 600; }
      .close { background: transparent; border: none; color: #fff; font-size: 18px; cursor: pointer; }
      .body { padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: #fff; }
      .row { display: grid; grid-template-columns: 36px 1fr; gap: 10px; align-items: flex-start; }
      .avatar { width: 36px; height: 36px; background: var(--brand); color: #fff; border-radius: 999px; display: grid; place-items: center; font-weight: 700; box-shadow: 0 6px 16px rgba(202,44,163,.35) }
      .bubble { background: var(--muted); color: #0f172a; padding: 12px 14px; border-radius: 12px; max-width: 100%; line-height: 1.35; animation: in-up .24s ease-out both; }
      .bubble.user { background: var(--brand); color: #fff; justify-self: end; }
      .options { display: flex; flex-direction: column; gap: 10px; }
      .option { background: #fff; border: 2px solid rgba(202,44,163,.35); color: #111827; border-radius: 12px; padding: 12px 14px; font-weight: 600; cursor: pointer; text-align: left; box-shadow: 0 4px 14px rgba(0,0,0,.08); animation: in-up .18s ease-out both; }
      .option:hover { border-color: var(--brand); box-shadow: 0 8px 22px rgba(202,44,163,.15); }
      .status { font-size: 12px; color: #6b7280; padding: 6px 14px; border-top: 1px solid rgba(0,0,0,.06); background: #fafafa; }
      .footer { padding: 10px; display: grid; grid-template-columns: 1fr auto; gap: 8px; border-top: 1px solid rgba(0,0,0,.06); background: #fff; }
      input[type="text"], input[type="email"], input[type="tel"] { border: 1px solid rgba(0,0,0,.12); border-radius: 12px; padding: 12px 14px; outline: none; }
      input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(202,44,163,.15); }
      button.primary { background: var(--brand); color: #fff; border: none; border-radius: 12px; padding: 12px 16px; font-weight: 700; cursor: pointer; }
      button.primary:disabled { opacity: .5; cursor: not-allowed; }
      .lead { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 2px; }
      .lead button { grid-column: 1 / -1; }
      @keyframes in-up { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0) } }
      @keyframes pop-in { from { opacity: 0; transform: translateY(6px) scale(.98) } to { opacity: 1; transform: translateY(0) scale(1) } }
    </style>
  </head>
  <body>
    <div class="surface">
      <div class="panel">
        <div class="header">
          <div class="title">
            <span style="display:inline-grid;place-items:center;width:22px;height:22px;background:#fff;color:var(--brand);border-radius:6px;font-size:12px;">ðŸ’¬</span>
            <span>Stellabot</span>
          </div>
          <div>
            <span class="ready">Ready</span>
          </div>
        </div>
        <div id="chat" class="body"></div>
        <div id="status" class="status">Loadingâ€¦</div>
        <div id="footer" class="footer" style="display:grid"></div>
      </div>
    </div>

    <script>
      (function(){
        const qs = new URLSearchParams(location.search)
        const API_BASE = (qs.get('api') || 'https://stellabot-backend.vercel.app').replace(/\/$/, '')
  const chatEl = document.getElementById('chat')
  const footerEl = document.getElementById('footer')
  const statusEl = document.getElementById('status')

        function getSessionId(){
          try {
            if (!window.localStorage) return ''
            let sid = localStorage.getItem('stellabot_session')
            if (!sid && window.crypto?.randomUUID){ sid = crypto.randomUUID(); localStorage.setItem('stellabot_session', sid) }
            if (!sid){ sid = 'web-' + Math.random().toString(36).slice(2); localStorage.setItem('stellabot_session', sid) }
            return sid
          } catch { return '' }
        }
        const sessionId = getSessionId()

        async function getStart(){
          const r = await fetch(API_BASE + '/api/chat/guide', { method: 'GET' })
          if(!r.ok){ throw new Error('guide GET ' + r.status) }
          return r.json()
        }
        async function postGuide(nextStepId){
          const r = await fetch(API_BASE + '/api/chat/guide', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sessionId, nextStepId }) })
          if(!r.ok){ throw new Error('guide POST ' + r.status) }
          return r.json()
        }
        async function enableAI(name, email){
          const r = await fetch(API_BASE + '/api/chat/enable-ai', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sessionId, name, email }) })
          if(!r.ok){ throw new Error('enable-ai ' + r.status) }
          return r.json()
        }
        async function askAI(message){
          const r = await fetch(API_BASE + '/api/chat/ia', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sessionId, message }) })
          if(!r.ok){ throw new Error('ia ' + r.status) }
          return r.json()
        }

        function renderMessage(text, who){
          const row = document.createElement('div')
          row.className = 'row'
          if ((who||'bot') === 'bot') {
            const av = document.createElement('div')
            av.className = 'avatar'
            av.textContent = 'ðŸ…‘'
            const b = document.createElement('div')
            b.className = 'bubble'
            b.textContent = text
            row.appendChild(av)
            row.appendChild(b)
          } else {
            const spacer = document.createElement('div')
            const b = document.createElement('div')
            b.className = 'bubble user'
            b.textContent = text
            row.appendChild(spacer)
            row.appendChild(b)
          }
          chatEl.appendChild(row)
          chatEl.scrollTop = chatEl.scrollHeight
        }
        function clearOptions(){
          const olds = chatEl.querySelectorAll('.options')
          olds.forEach(n => n.remove())
        }
        function renderOptions(options){
          clearOptions()
          const wrap = document.createElement('div')
          wrap.className = 'options'
          options.forEach((opt, idx) => {
            const b = document.createElement('button')
            b.className = 'option'
            b.style.animationDelay = (idx * 40) + 'ms'
            b.textContent = opt.text
            b.addEventListener('click', async () => {
              try { const data = await postGuide(opt.nextStepId); renderStep(data) } catch(e){ console.error(e); alert('Failed to fetch') }
            })
            wrap.appendChild(b)
          })
          chatEl.appendChild(wrap)
          chatEl.scrollTop = chatEl.scrollHeight
        }
        function renderLeadForm(){
          const lead = document.createElement('div')
          lead.className = 'lead'
          lead.innerHTML = `
            <input id="name" type="text" placeholder="Your name"/>
            <input id="email" type="email" placeholder="Your email"/>
            <button class="primary">Enable AI</button>
            <div class="hint">We'll activate the AI chat after your details.</div>
          `
          chatEl.appendChild(lead)
          const btn = lead.querySelector('button')
          btn.addEventListener('click', async () => {
            const name = lead.querySelector('#name').value.trim()
            const email = lead.querySelector('#email').value.trim()
            if(!name || !email) { alert('Please enter name and email'); return }
            try { await enableAI(name, email); alert('AI enabled. You can ask questions now.'); showFooterInput(true) } catch(e){ console.error(e); alert('Failed to enable AI') }
          })
          chatEl.scrollTop = chatEl.scrollHeight
        }
        function showFooterInput(enabled, guidedCount){
          footerEl.style.display = 'grid'
          footerEl.innerHTML = ''
          const input = document.createElement('input')
          input.type = 'text'
          input.placeholder = enabled ? 'Ask me anythingâ€¦' : 'AI locked. Provide your details above.'
          input.disabled = !enabled
          const send = document.createElement('button')
          send.className = 'primary'
          send.textContent = 'Send'
          send.disabled = !enabled
          footerEl.appendChild(input)
          footerEl.appendChild(send)
          send.addEventListener('click', async () => {
            const v = input.value.trim()
            if(!v) return
            renderMessage(v, 'user')
            input.value = ''
            try {
              const r = await askAI(v)
              renderMessage(r.reply, 'bot')
            } catch(e){ console.error(e); alert('Failed to ask AI') }
          })
          const remaining = Math.max(0, 5 - (guidedCount||0))
          statusEl.textContent = enabled ? 'AI unlocked. You can chat freely.' : `Guided interactions: ${guidedCount||0}. AI unlocks after completing 5 steps${remaining>0?` (${remaining} remaining)`:''}.`
        }
        function renderStep(data){
          // Clear options/footer each step to simplify
          showFooterInput(data.aiEnabled === true, data.guidedCount)
          renderMessage(data.text, 'bot')
          if (Array.isArray(data.options) && data.options.length) {
            renderOptions(data.options)
          }
          // If AI available but not yet enabled, render lead prompt
          if (data.aiAvailable && !data.aiEnabled) {
            renderLeadForm()
          }
        }

        (async function start(){
          try {
            const data = await getStart()
            renderStep(data)
          } catch(e){ console.error(e); renderMessage('Failed to load chat. Please try again later.', 'bot') }
        })()
      })()
    </script>
  </body>
</html>
